<!doctype html><html lang=en dir=auto><head><meta charset=utf-8><meta http-equiv=x-ua-compatible content="IE=edge"><meta name=viewport content="width=device-width,initial-scale=1,shrink-to-fit=no"><meta name=robots content="index, follow"><title>[회고] heic-convert 분석 - NodeJS 라이브러리 | Crispy bLog</title><meta name=keywords content="HEIF,Node에서 HEIC 이미지 가공하기"><meta name=description content="TL;DR 커뮤니티 만들때 HEIF파일을 JPEG로 바꾸어 다루면 편합니다. NodeJS에서 이를 구현한 heic-converter 라이브러리를 분석해 봅니다. 왜 와이 커뮤니티를 만들때면 이미지를 입력 받는 경우가 있습니다. 이때 애플의 아이폰/아이패드의 경우, 고효율 압축 방식인 HEIF(High Efficiency Image File Format) 방식을 사용합니다. 당연하게도, ISO 표준인 JPEG(Joint Photographic Expert Group) 등과는 다른 파일 형식을 가지고 있습니다.
만약 node에서 sharp를 이용해 heif로 파일을 처리하고자 한다면 이 과정은 정말 쉽지 않습니다. HEIF는 HEVC(High Efficiency Video Coding)을 이용해 compression을 하기 때문에 libde265와 x265 같은 라이브러리가 추가로 필요하기 때문입니다."><meta name=author content="Crispy"><link rel=canonical href=https://heozeop.github.io/post/research-heic-converter/><link crossorigin=anonymous href=/assets/css/stylesheet.d7fb4cbf980fe688a21621b06a795933c4e6bb2d4070ec940667af1715d84af2.css integrity="sha256-1/tMv5gP5oiiFiGwanlZM8Tmuy1AcOyUBmevFxXYSvI=" rel="preload stylesheet" as=style><script defer crossorigin=anonymous src=/assets/js/highlight.f413e19d0714851f6474e7ee9632408e58ac146fbdbe62747134bea2fa3415e0.js integrity="sha256-9BPhnQcUhR9kdOfuljJAjlisFG+9vmJ0cTS+ovo0FeA=" onload=hljs.initHighlightingOnLoad()></script>
<link rel=icon href=https://heozeop.github.io/favicon.ico><link rel=icon type=image/png sizes=16x16 href=https://heozeop.github.io/favicon-16x16.png><link rel=icon type=image/png sizes=32x32 href=https://heozeop.github.io/favicon-32x32.png><link rel=apple-touch-icon href=https://heozeop.github.io/apple-touch-icon.png><link rel=mask-icon href=https://heozeop.github.io/safari-pinned-tab.svg><meta name=theme-color content="#2e2e33"><meta name=msapplication-TileColor content="#2e2e33"><noscript><style>#theme-toggle,.top-link{display:none}</style><style>@media(prefers-color-scheme:dark){:root{--theme:rgb(29, 30, 32);--entry:rgb(46, 46, 51);--primary:rgb(218, 218, 219);--secondary:rgb(155, 156, 157);--tertiary:rgb(65, 66, 68);--content:rgb(196, 196, 197);--hljs-bg:rgb(46, 46, 51);--code-bg:rgb(55, 56, 62);--border:rgb(51, 51, 51)}.list{background:var(--theme)}.list:not(.dark)::-webkit-scrollbar-track{background:0 0}.list:not(.dark)::-webkit-scrollbar-thumb{border-color:var(--theme)}}</style></noscript><meta property="og:title" content="[회고] heic-convert 분석 - NodeJS 라이브러리"><meta property="og:description" content="TL;DR 커뮤니티 만들때 HEIF파일을 JPEG로 바꾸어 다루면 편합니다. NodeJS에서 이를 구현한 heic-converter 라이브러리를 분석해 봅니다. 왜 와이 커뮤니티를 만들때면 이미지를 입력 받는 경우가 있습니다. 이때 애플의 아이폰/아이패드의 경우, 고효율 압축 방식인 HEIF(High Efficiency Image File Format) 방식을 사용합니다. 당연하게도, ISO 표준인 JPEG(Joint Photographic Expert Group) 등과는 다른 파일 형식을 가지고 있습니다.
만약 node에서 sharp를 이용해 heif로 파일을 처리하고자 한다면 이 과정은 정말 쉽지 않습니다. HEIF는 HEVC(High Efficiency Video Coding)을 이용해 compression을 하기 때문에 libde265와 x265 같은 라이브러리가 추가로 필요하기 때문입니다."><meta property="og:type" content="article"><meta property="og:url" content="https://heozeop.github.io/post/research-heic-converter/"><meta property="og:image" content="https://heozeop.github.io/static/%ED%94%84%EB%A1%9C%ED%95%84%20%EC%9D%B4%EB%AF%B8%EC%A7%80.jpeg"><meta property="article:section" content="post"><meta property="article:published_time" content="2024-01-25T18:36:44+09:00"><meta property="article:modified_time" content="2024-01-25T18:36:44+09:00"><meta property="og:site_name" content="Crispy bLog"><meta name=twitter:card content="summary_large_image"><meta name=twitter:image content="https://heozeop.github.io/static/%ED%94%84%EB%A1%9C%ED%95%84%20%EC%9D%B4%EB%AF%B8%EC%A7%80.jpeg"><meta name=twitter:title content="[회고] heic-convert 분석 - NodeJS 라이브러리"><meta name=twitter:description content="TL;DR 커뮤니티 만들때 HEIF파일을 JPEG로 바꾸어 다루면 편합니다. NodeJS에서 이를 구현한 heic-converter 라이브러리를 분석해 봅니다. 왜 와이 커뮤니티를 만들때면 이미지를 입력 받는 경우가 있습니다. 이때 애플의 아이폰/아이패드의 경우, 고효율 압축 방식인 HEIF(High Efficiency Image File Format) 방식을 사용합니다. 당연하게도, ISO 표준인 JPEG(Joint Photographic Expert Group) 등과는 다른 파일 형식을 가지고 있습니다.
만약 node에서 sharp를 이용해 heif로 파일을 처리하고자 한다면 이 과정은 정말 쉽지 않습니다. HEIF는 HEVC(High Efficiency Video Coding)을 이용해 compression을 하기 때문에 libde265와 x265 같은 라이브러리가 추가로 필요하기 때문입니다."><script type=application/ld+json>{"@context":"https://schema.org","@type":"BreadcrumbList","itemListElement":[{"@type":"ListItem","position":1,"name":"Posts","item":"https://heozeop.github.io/post/"},{"@type":"ListItem","position":2,"name":"[회고] heic-convert 분석 - NodeJS 라이브러리","item":"https://heozeop.github.io/post/research-heic-converter/"}]}</script><script type=application/ld+json>{"@context":"https://schema.org","@type":"BlogPosting","headline":"[회고] heic-convert 분석 - NodeJS 라이브러리","name":"[회고] heic-convert 분석 - NodeJS 라이브러리","description":"TL;DR 커뮤니티 만들때 HEIF파일을 JPEG로 바꾸어 다루면 편합니다. NodeJS에서 이를 구현한 heic-converter 라이브러리를 분석해 봅니다. 왜 와이 커뮤니티를 만들때면 이미지를 입력 받는 경우가 있습니다. 이때 애플의 아이폰/아이패드의 경우, 고효율 압축 방식인 HEIF(High Efficiency Image File Format) 방식을 사용합니다. 당연하게도, ISO 표준인 JPEG(Joint Photographic Expert Group) 등과는 다른 파일 형식을 가지고 있습니다.\n만약 node에서 sharp를 이용해 heif로 파일을 처리하고자 한다면 이 과정은 정말 쉽지 않습니다. HEIF는 HEVC(High Efficiency Video Coding)을 이용해 compression을 하기 때문에 libde265와 x265 같은 라이브러리가 추가로 필요하기 때문입니다.","keywords":["HEIF","Node에서 HEIC 이미지 가공하기"],"articleBody":" TL;DR 커뮤니티 만들때 HEIF파일을 JPEG로 바꾸어 다루면 편합니다. NodeJS에서 이를 구현한 heic-converter 라이브러리를 분석해 봅니다. 왜 와이 커뮤니티를 만들때면 이미지를 입력 받는 경우가 있습니다. 이때 애플의 아이폰/아이패드의 경우, 고효율 압축 방식인 HEIF(High Efficiency Image File Format) 방식을 사용합니다. 당연하게도, ISO 표준인 JPEG(Joint Photographic Expert Group) 등과는 다른 파일 형식을 가지고 있습니다.\n만약 node에서 sharp를 이용해 heif로 파일을 처리하고자 한다면 이 과정은 정말 쉽지 않습니다. HEIF는 HEVC(High Efficiency Video Coding)을 이용해 compression을 하기 때문에 libde265와 x265 같은 라이브러리가 추가로 필요하기 때문입니다. 이전에 이 방식으로 heic 파일을 변환하고자 많은 시간을 녹였던 기억이 납니다.\n이 글은 HEIF 파일을 JPEG로 바꾸어 다루는 아이디어 부터 출발해, 이 아이디어를 구현한 npm 라이브러리인 heic-converter를 분석했던 과정을 회고하는 글입니다. 더 자세하게는 libheif.js 파일이 어떻게 생기는지 살펴보고자 분석을 하는 글이니, HEIF에 대한 자세한 설명 등은 킹무위키나 chatgpt등을 참조해 주세요.\n시작은 소스코드에서부터 heic-convert | https://github.com/catdad-experiments/heic-convert/tree/master\n폴더 구조를 먼저 살펴 봅니다. 아무래도 lib.js 가 핵심 로직을 담고 있는 것으로 보이는 군요.\nlib.js 전문이 40줄 정도밖에 안되는 간단한 코드입니다. 여기서 주목할 함수는 convert라는 함수입니다. convert를 따라가면, 주입받은 decode함수로 buffer를 해석하고, convertImage함수로 이미지를 변환합니다. convertImage함수는 주입 받은 encode함수를 이용해 형식을 변환하는 것으로 보입니다.\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 module.exports = (decode, encode) =\u003e { const convertImage = async ({ image, format, quality }) =\u003e { return await encode[format]({ // ... }); }; const convert = async ({ buffer, format, quality, all }) =\u003e { if (!encode[format]) { throw new Error(`output format needs to be one of [${Object.keys(encode)}]`); } if (!all) { const image = await decode({ buffer }); return await convertImage({ image, format, quality }); } // ... }; // ... }; index.js 그럼 이제 주입 받는 decode함수와 encode함수를 찾아갑니다.\n1 2 3 4 5 6 const decode = require('heic-decode'); const formats = require('./formats-node.js'); const { one, all } = require('./lib.js')(decode, formats); module.exports = one; module.exports.all = all; decode함수는 heic-decode라는 라이브러리인 것을 알 수 있습니다. encode함수는 formats-node.js에 있겠군요\nformats-node.js 지원하는 형식은 PNG형식과 JPEG형식만이군요! 다른 형식이 필요하면 이 부분을 수정하면 되겠어요.\n1 2 3 4 5 6 7 8 9 10 const jpegJs = require('jpeg-js'); const { PNG } = require('pngjs'); module.exports = {}; module.exports.JPEG = ({ data, width, height, quality }) =\u003e jpegJs.encode({ data, width, height }, Math.floor(quality * 100)).data; module.exports.PNG = ({ data, width, height }) =\u003e { // ... }; 정리 convert함수는 하나의 HEIF 포멧 버퍼를 변환하는 함수로, heic-decode 라이브러리를 이용해 HEIF 버퍼를 변환합니다. 그리고 변환한 버퍼를 JPEG나 PNG포멧으로 변경합니다.\nheic-decode 그럼 다음으로는 HEIF 버퍼를 실제로 변환하는 heic-decode를 까보겠습니다. 같은 사람이 만들어 그런지 구조는 비슷하군요! 일단 lib.js부터 열어보면 될 것 같습니다.\nlib.js 이번에는 80줄이 되는 코드라 buffer를 decode하는 로직만 발췌하였습니다. 결국 libheif를 주입 받아 decode를 하게 되는 군요.\n1 2 3 4 5 6 7 8 9 10 11 12 13 // ... module.exports = libheif =\u003e { const decodeBuffer = async ({ buffer, all }) =\u003e { // ... const decoder = new libheif.HeifDecoder(); const data = decoder.decode(buffer); // ... }; // ... }; index.js 그럼 이제 여기만 보면 어떻게 libheif를 주입하는지 알 수 있을 겁니다. libheif-js의 wasm-bundle을 이용하는군요! 왜 wasm인지는 차치하고 일단 넘어가 봅시다.\n1 2 3 4 5 6 const libheif = require('libheif-js/wasm-bundle'); const { one, all } = require('./lib.js')(libheif); module.exports = one; module.exports.all = all; 정리 libheif-js를 주입받아 HEIF파일을 변환합니다.\nlibheif-js 살펴볼 파일은 wasm.js, wasm-bundle.js이겠군요. 일단 이전과 구조가 다르니 index.js먼저 살펴보도록 합시다.\nindex.js ???\njs번들을 만드는 건가? 바로 wasm-bundle.js를 살펴봐야겠군요.\n1 module.exports = require('./libheif/libheif.js')(); wasm-bundle.js ???\n남은 wasm.js를 봐야겠습니다.\n1 module.exports = require('./libheif-wasm/libheif-bundle.js')(); wasm.js 자, 여기까지 나온 것을 보고 생각해 보았습니다. 이제 찾아야 하는 것은 다음 폴더들이 어떻게 만들어지는지 알아보는 것입니다.\nlibheif-wasm 1 2 3 4 5 6 // I technically don't have to do this, but I am keeping it around // for demonstration purposes const fs = require('fs'); const wasmBinary = fs.readFileSync('./libheif-wasm/libheif.wasm'); module.exports = require('./libheif-wasm/libheif.js')({ wasmBinary }); scripts/install.js 일단 libheif를 설치하는 부분으로 보입니다. libheif를 다운받고, esbuild를 통해 libheif-wasm/libheif-bundle.js를 만들어 내는 군요\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 // ... const base = `https://github.com/catdad-experiments/libheif-emscripten/releases/download/${version}`; const tarball = `${base}/libheif.tar.gz`; // ... (async () =\u003e { // ... await fs.outputFile(outfile, await autoReadStream(entry)); //... await esbuild.build({ ...buildOptions, outfile: path.resolve(root, 'libheif-wasm/libheif-bundle.js'), format: 'iife', globalName: 'libheif', //... }); // ... }) //... 정리 libheif를 직접 다운 받아 libheif를 번들링 합니다. libheif/libheif.js는 libheif-emscripten을 살펴 봐야겠습니다.\nlibheif-emscripten 파일이 별게 없군요. githu workflow와 스크립트 파일 정도를 살펴볼 수 있겠습니다.\ndist-prep.sh dist로 libheif.js를 복사하는 스크립트입니다. 이 스크립트가 시작될때면 libheif.js를 가지고 있다는 말이 된다는 이야기네요.\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 // ... build_target=\"$1\" // ... function copyJs() { cp libheif/libheif.js dist/libheif.js cp libheif/COPYING dist/LICENSE assertFile dist/libheif.js assertFile dist/LICENSE chown $(whoami) dist/libheif.js dist/LICENSE } // ... if [ \"$build_target\" = \"js\" ] then copyJs // ... .github/workflows/emscripten.yml 아, 드디어 찾았습니다. libheif를 여기서 다운을 받는 군요. 이제 libheif를 살펴보면 될 것 같습니다. libheif의 스크립트 중 install-cli-linux.sh, prepare-ci.sh, run-ci.sh를 보면 되겠군요.\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 // ... - name: Install emscripten working-directory: libheif run: | ./scripts/install-ci-linux.sh - name: Prepare CI working-directory: libheif run: | ./scripts/prepare-ci.sh - name: Run build and tests (JS) if: ${{ matrix.target=='js' }} working-directory: libheif run: | ./scripts/run-ci.sh // ... - name: Dist prep run: ./dist-prep.sh ${{ matrix.target }} // ... 정리 libheif의 스크립트를 이용해 libheif.js를 만들어 냅니다.\nlibheif sh파일은 길기 때문에 제가 읽고 파악한 부분만 서술하겠습니다.\ninstall-ci-linux.sh decoder(libde265), encoder(x265) 등을 다운 받습니다.\nprepare-ci.sh flag를 기준으로 포함하는 PKG_CONFIG_PATH를 설정합니다.\nrun-ci.sh 여기서 build-emscripten.sh를 호출해 파일을 생성하는 것으로 보입니다. emscripten은 LLVM컴파일러의 백엔드로, 소스를 javascript/wasm로 변환할 수 있는 프로그램이라고 합니다.\nbuild-emscripten.sh 여기서 post.js를 기반으로 한 파일을 만들어 줍니다. 실제로 post.js를 보면 어떻게 사용하고 있는지 볼 수 있습니다.\n정리 차례로 dependency를 설치 및 설정하고 build-emscripten.sh에서 emscripten을 이용해 libheif.js를 생성합니다.\n정리하기 긴 여정이었습니다. 지금까지 5개의 레포를 넘어가면서 어떻게 libheif.js 파일이 생성되는지를 알아보았습니다. 결과적으로 heic-convert라이브러리는 libheif.js를 기반으로 돌고 있으며, 이를 이용해 HEIF파일을 다른 형식으로 전환할 수 있다는 것을 알았습니다. 별안간 지식이 늘어 기쁘네요.\n그럼 긴 글 읽어 주셔서 감사드리며, 이만 물러가겠습니다.\nref https://cloudinary.com/guides/image-formats/heif-format-meet-the-the-next-evolution-of-jpeg 킹무위키 HEIF heic-convert heic-decode libheif-js libheif-emscripten libheif emscripten ","wordCount":"1018","inLanguage":"en","datePublished":"2024-01-25T18:36:44+09:00","dateModified":"2024-01-25T18:36:44+09:00","author":{"@type":"Person","name":"Crispy"},"mainEntityOfPage":{"@type":"WebPage","@id":"https://heozeop.github.io/post/research-heic-converter/"},"publisher":{"@type":"Organization","name":"Crispy bLog","logo":{"@type":"ImageObject","url":"https://heozeop.github.io/favicon.ico"}}}</script></head><body id=top><script>localStorage.getItem("pref-theme")==="dark"?document.body.classList.add("dark"):localStorage.getItem("pref-theme")==="light"?document.body.classList.remove("dark"):window.matchMedia("(prefers-color-scheme: dark)").matches&&document.body.classList.add("dark")</script><header class=header><nav class=nav><div class=logo><a href=https://heozeop.github.io/ accesskey=h title="Crispy bLog (Alt + H)">Crispy bLog</a><div class=logo-switches><button id=theme-toggle accesskey=t title="(Alt + T)"><svg id="moon" xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M21 12.79A9 9 0 1111.21 3 7 7 0 0021 12.79z"/></svg><svg id="sun" xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="5"/><line x1="12" y1="1" x2="12" y2="3"/><line x1="12" y1="21" x2="12" y2="23"/><line x1="4.22" y1="4.22" x2="5.64" y2="5.64"/><line x1="18.36" y1="18.36" x2="19.78" y2="19.78"/><line x1="1" y1="12" x2="3" y2="12"/><line x1="21" y1="12" x2="23" y2="12"/><line x1="4.22" y1="19.78" x2="5.64" y2="18.36"/><line x1="18.36" y1="5.64" x2="19.78" y2="4.22"/></svg></button></div></div><ul id=menu><li><a href=https://heozeop.github.io/categories/ title=categories><span>categories</span></a></li><li><a href=https://heozeop.github.io/tags/ title=tags><span>tags</span></a></li></ul></nav></header><main class=main><article class=post-single><header class=post-header><div class=breadcrumbs><a href=https://heozeop.github.io/>Home</a>&nbsp;»&nbsp;<a href=https://heozeop.github.io/post/>Posts</a></div><h1 class=post-title>[회고] heic-convert 분석 - NodeJS 라이브러리</h1><div class=post-meta><span title='2024-01-25 18:36:44 +0900 KST'>January 25, 2024</span>&nbsp;·&nbsp;5 min&nbsp;·&nbsp;1018 words&nbsp;·&nbsp;Crispy&nbsp;|&nbsp;<a href=https://github.com/heozeop/I-want-to-know-why/content/post/research-heic-converter.md rel="noopener noreferrer" target=_blank>Suggest Changes</a></div></header><div class=post-content><h1 id=heading><a hidden class=anchor aria-hidden=true href=#heading>#</a></h1><h1 id=tldr>TL;DR<a hidden class=anchor aria-hidden=true href=#tldr>#</a></h1><ul><li>커뮤니티 만들때 HEIF파일을 JPEG로 바꾸어 다루면 편합니다.</li><li>NodeJS에서 이를 구현한 heic-converter 라이브러리를 분석해 봅니다.</li></ul><h1 id=왜-와이>왜 와이<a hidden class=anchor aria-hidden=true href=#왜-와이>#</a></h1><p>커뮤니티를 만들때면 이미지를 입력 받는 경우가 있습니다.
이때 애플의 아이폰/아이패드의 경우, 고효율 압축 방식인 HEIF(High Efficiency Image File Format) 방식을 사용합니다.
당연하게도, ISO 표준인 JPEG(Joint Photographic Expert Group) 등과는 다른 파일 형식을 가지고 있습니다.</p><p>만약 node에서 sharp를 이용해 heif로 파일을 처리하고자 한다면 이 과정은 정말 쉽지 않습니다.
HEIF는 HEVC(High Efficiency Video Coding)을 이용해 compression을 하기 때문에 libde265와 x265 같은 라이브러리가 추가로 필요하기 때문입니다.
이전에 이 방식으로 heic 파일을 변환하고자 많은 시간을 녹였던 기억이 납니다.</p><p>이 글은 HEIF 파일을 JPEG로 바꾸어 다루는 아이디어 부터 출발해, 이 아이디어를 구현한 npm 라이브러리인 heic-converter를 분석했던 과정을 회고하는 글입니다.
더 자세하게는 libheif.js 파일이 어떻게 생기는지 살펴보고자 분석을 하는 글이니, HEIF에 대한 자세한 설명 등은 <a href=https://namu.wiki/w/HEIF>킹무위키</a>나 chatgpt등을 참조해 주세요.</p><h1 id=시작은-소스코드에서부터>시작은 소스코드에서부터<a hidden class=anchor aria-hidden=true href=#시작은-소스코드에서부터>#</a></h1><h2 id=heic-convert>heic-convert<a hidden class=anchor aria-hidden=true href=#heic-convert>#</a></h2><p>| <a href=https://github.com/catdad-experiments/heic-convert/tree/master>https://github.com/catdad-experiments/heic-convert/tree/master</a></p><p>폴더 구조를 먼저 살펴 봅니다. 아무래도 <code>lib.js</code> 가 핵심 로직을 담고 있는 것으로 보이는 군요.</p><h3 id=libjs>lib.js<a hidden class=anchor aria-hidden=true href=#libjs>#</a></h3><p>전문이 40줄 정도밖에 안되는 간단한 코드입니다. 여기서 주목할 함수는 convert라는 함수입니다.
convert를 따라가면, 주입받은 <code>decode</code>함수로 buffer를 해석하고, <code>convertImage</code>함수로 이미지를 변환합니다.
<code>convertImage</code>함수는 주입 받은 <code>encode</code>함수를 이용해 형식을 변환하는 것으로 보입니다.</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span><span class=lnt>21
</span><span class=lnt>22
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-javascript data-lang=javascript><span class=line><span class=cl><span class=nx>module</span><span class=p>.</span><span class=nx>exports</span> <span class=o>=</span> <span class=p>(</span><span class=nx>decode</span><span class=p>,</span> <span class=nx>encode</span><span class=p>)</span> <span class=p>=&gt;</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>  <span class=kr>const</span> <span class=nx>convertImage</span> <span class=o>=</span> <span class=kr>async</span> <span class=p>({</span> <span class=nx>image</span><span class=p>,</span> <span class=nx>format</span><span class=p>,</span> <span class=nx>quality</span> <span class=p>})</span> <span class=p>=&gt;</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=k>return</span> <span class=kr>await</span> <span class=nx>encode</span><span class=p>[</span><span class=nx>format</span><span class=p>]({</span>
</span></span><span class=line><span class=cl>        <span class=c1>// ...
</span></span></span><span class=line><span class=cl><span class=c1></span>   <span class=p>});</span>
</span></span><span class=line><span class=cl>  <span class=p>};</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>  <span class=kr>const</span> <span class=nx>convert</span> <span class=o>=</span> <span class=kr>async</span> <span class=p>({</span> <span class=nx>buffer</span><span class=p>,</span> <span class=nx>format</span><span class=p>,</span> <span class=nx>quality</span><span class=p>,</span> <span class=nx>all</span> <span class=p>})</span> <span class=p>=&gt;</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=k>if</span> <span class=p>(</span><span class=o>!</span><span class=nx>encode</span><span class=p>[</span><span class=nx>format</span><span class=p>])</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>      <span class=k>throw</span> <span class=k>new</span> <span class=nb>Error</span><span class=p>(</span><span class=sb>`output format needs to be one of [</span><span class=si>${</span><span class=nb>Object</span><span class=p>.</span><span class=nx>keys</span><span class=p>(</span><span class=nx>encode</span><span class=p>)</span><span class=si>}</span><span class=sb>]`</span><span class=p>);</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=k>if</span> <span class=p>(</span><span class=o>!</span><span class=nx>all</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>      <span class=kr>const</span> <span class=nx>image</span> <span class=o>=</span> <span class=kr>await</span> <span class=nx>decode</span><span class=p>({</span> <span class=nx>buffer</span> <span class=p>});</span>
</span></span><span class=line><span class=cl>      <span class=k>return</span> <span class=kr>await</span> <span class=nx>convertImage</span><span class=p>({</span> <span class=nx>image</span><span class=p>,</span> <span class=nx>format</span><span class=p>,</span> <span class=nx>quality</span> <span class=p>});</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=c1>// ...
</span></span></span><span class=line><span class=cl><span class=c1></span>  <span class=p>};</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>  <span class=c1>// ...
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=p>};</span>
</span></span></code></pre></td></tr></table></div></div><h3 id=indexjs>index.js<a hidden class=anchor aria-hidden=true href=#indexjs>#</a></h3><p>그럼 이제 주입 받는 <code>decode</code>함수와 <code>encode</code>함수를 찾아갑니다.</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span><span class=lnt>5
</span><span class=lnt>6
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-javascript data-lang=javascript><span class=line><span class=cl><span class=kr>const</span> <span class=nx>decode</span> <span class=o>=</span> <span class=nx>require</span><span class=p>(</span><span class=s1>&#39;heic-decode&#39;</span><span class=p>);</span>
</span></span><span class=line><span class=cl><span class=kr>const</span> <span class=nx>formats</span> <span class=o>=</span> <span class=nx>require</span><span class=p>(</span><span class=s1>&#39;./formats-node.js&#39;</span><span class=p>);</span>
</span></span><span class=line><span class=cl><span class=kr>const</span> <span class=p>{</span> <span class=nx>one</span><span class=p>,</span> <span class=nx>all</span> <span class=p>}</span> <span class=o>=</span> <span class=nx>require</span><span class=p>(</span><span class=s1>&#39;./lib.js&#39;</span><span class=p>)(</span><span class=nx>decode</span><span class=p>,</span> <span class=nx>formats</span><span class=p>);</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=nx>module</span><span class=p>.</span><span class=nx>exports</span> <span class=o>=</span> <span class=nx>one</span><span class=p>;</span>
</span></span><span class=line><span class=cl><span class=nx>module</span><span class=p>.</span><span class=nx>exports</span><span class=p>.</span><span class=nx>all</span> <span class=o>=</span> <span class=nx>all</span><span class=p>;</span>
</span></span></code></pre></td></tr></table></div></div><p><code>decode</code>함수는 <code>heic-decode</code>라는 라이브러리인 것을 알 수 있습니다. <code>encode</code>함수는 <code>formats-node.js</code>에 있겠군요</p><h3 id=formats-nodejs>formats-node.js<a hidden class=anchor aria-hidden=true href=#formats-nodejs>#</a></h3><p>지원하는 형식은 PNG형식과 JPEG형식만이군요! 다른 형식이 필요하면 이 부분을 수정하면 되겠어요.</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-javascript data-lang=javascript><span class=line><span class=cl><span class=kr>const</span> <span class=nx>jpegJs</span> <span class=o>=</span> <span class=nx>require</span><span class=p>(</span><span class=s1>&#39;jpeg-js&#39;</span><span class=p>);</span>
</span></span><span class=line><span class=cl><span class=kr>const</span> <span class=p>{</span> <span class=nx>PNG</span> <span class=p>}</span> <span class=o>=</span> <span class=nx>require</span><span class=p>(</span><span class=s1>&#39;pngjs&#39;</span><span class=p>);</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=nx>module</span><span class=p>.</span><span class=nx>exports</span> <span class=o>=</span> <span class=p>{};</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=nx>module</span><span class=p>.</span><span class=nx>exports</span><span class=p>.</span><span class=nx>JPEG</span> <span class=o>=</span> <span class=p>({</span> <span class=nx>data</span><span class=p>,</span> <span class=nx>width</span><span class=p>,</span> <span class=nx>height</span><span class=p>,</span> <span class=nx>quality</span> <span class=p>})</span> <span class=p>=&gt;</span> <span class=nx>jpegJs</span><span class=p>.</span><span class=nx>encode</span><span class=p>({</span> <span class=nx>data</span><span class=p>,</span> <span class=nx>width</span><span class=p>,</span> <span class=nx>height</span> <span class=p>},</span> <span class=nb>Math</span><span class=p>.</span><span class=nx>floor</span><span class=p>(</span><span class=nx>quality</span> <span class=o>*</span> <span class=mi>100</span><span class=p>)).</span><span class=nx>data</span><span class=p>;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=nx>module</span><span class=p>.</span><span class=nx>exports</span><span class=p>.</span><span class=nx>PNG</span> <span class=o>=</span> <span class=p>({</span> <span class=nx>data</span><span class=p>,</span> <span class=nx>width</span><span class=p>,</span> <span class=nx>height</span> <span class=p>})</span> <span class=p>=&gt;</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>  <span class=c1>// ...
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=p>};</span>
</span></span></code></pre></td></tr></table></div></div><h3 id=정리>정리<a hidden class=anchor aria-hidden=true href=#정리>#</a></h3><p><code>convert</code>함수는 하나의 HEIF 포멧 버퍼를 변환하는 함수로, <code>heic-decode</code> 라이브러리를 이용해 HEIF 버퍼를 변환합니다.
그리고 변환한 버퍼를 JPEG나 PNG포멧으로 변경합니다.</p><h2 id=heic-decode>heic-decode<a hidden class=anchor aria-hidden=true href=#heic-decode>#</a></h2><p>그럼 다음으로는 HEIF 버퍼를 실제로 변환하는 <code>heic-decode</code>를 까보겠습니다.
같은 사람이 만들어 그런지 구조는 비슷하군요!
일단 <code>lib.js</code>부터 열어보면 될 것 같습니다.</p><h3 id=libjs-1>lib.js<a hidden class=anchor aria-hidden=true href=#libjs-1>#</a></h3><p>이번에는 80줄이 되는 코드라 buffer를 decode하는 로직만 발췌하였습니다. 결국 libheif를 주입 받아 decode를 하게 되는 군요.</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-javascript data-lang=javascript><span class=line><span class=cl><span class=c1>// ...
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=nx>module</span><span class=p>.</span><span class=nx>exports</span> <span class=o>=</span> <span class=nx>libheif</span> <span class=p>=&gt;</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>  <span class=kr>const</span> <span class=nx>decodeBuffer</span> <span class=o>=</span> <span class=kr>async</span> <span class=p>({</span> <span class=nx>buffer</span><span class=p>,</span> <span class=nx>all</span> <span class=p>})</span> <span class=p>=&gt;</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=c1>// ...
</span></span></span><span class=line><span class=cl><span class=c1></span>
</span></span><span class=line><span class=cl>    <span class=kr>const</span> <span class=nx>decoder</span> <span class=o>=</span> <span class=k>new</span> <span class=nx>libheif</span><span class=p>.</span><span class=nx>HeifDecoder</span><span class=p>();</span>
</span></span><span class=line><span class=cl>    <span class=kr>const</span> <span class=nx>data</span> <span class=o>=</span> <span class=nx>decoder</span><span class=p>.</span><span class=nx>decode</span><span class=p>(</span><span class=nx>buffer</span><span class=p>);</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=c1>// ...
</span></span></span><span class=line><span class=cl><span class=c1></span>  <span class=p>};</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>  <span class=c1>// ...
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=p>};</span>
</span></span></code></pre></td></tr></table></div></div><h3 id=indexjs-1>index.js<a hidden class=anchor aria-hidden=true href=#indexjs-1>#</a></h3><p>그럼 이제 여기만 보면 어떻게 libheif를 주입하는지 알 수 있을 겁니다.
<code>libheif-js</code>의 wasm-bundle을 이용하는군요! 왜 wasm인지는 차치하고 일단 넘어가 봅시다.</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span><span class=lnt>5
</span><span class=lnt>6
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-javascript data-lang=javascript><span class=line><span class=cl><span class=kr>const</span> <span class=nx>libheif</span> <span class=o>=</span> <span class=nx>require</span><span class=p>(</span><span class=s1>&#39;libheif-js/wasm-bundle&#39;</span><span class=p>);</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=kr>const</span> <span class=p>{</span> <span class=nx>one</span><span class=p>,</span> <span class=nx>all</span> <span class=p>}</span> <span class=o>=</span> <span class=nx>require</span><span class=p>(</span><span class=s1>&#39;./lib.js&#39;</span><span class=p>)(</span><span class=nx>libheif</span><span class=p>);</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=nx>module</span><span class=p>.</span><span class=nx>exports</span> <span class=o>=</span> <span class=nx>one</span><span class=p>;</span>
</span></span><span class=line><span class=cl><span class=nx>module</span><span class=p>.</span><span class=nx>exports</span><span class=p>.</span><span class=nx>all</span> <span class=o>=</span> <span class=nx>all</span><span class=p>;</span>
</span></span></code></pre></td></tr></table></div></div><h3 id=정리-1>정리<a hidden class=anchor aria-hidden=true href=#정리-1>#</a></h3><p><code>libheif-js</code>를 주입받아 HEIF파일을 변환합니다.</p><h2 id=libheif-js>libheif-js<a hidden class=anchor aria-hidden=true href=#libheif-js>#</a></h2><p>살펴볼 파일은 <code>wasm.js</code>, <code>wasm-bundle.js</code>이겠군요. 일단 이전과 구조가 다르니 <code>index.js</code>먼저 살펴보도록 합시다.</p><h3 id=indexjs-2>index.js<a hidden class=anchor aria-hidden=true href=#indexjs-2>#</a></h3><blockquote><p>???</p></blockquote><p>js번들을 만드는 건가? 바로 <code>wasm-bundle.js</code>를 살펴봐야겠군요.</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-javascript data-lang=javascript><span class=line><span class=cl><span class=nx>module</span><span class=p>.</span><span class=nx>exports</span> <span class=o>=</span> <span class=nx>require</span><span class=p>(</span><span class=s1>&#39;./libheif/libheif.js&#39;</span><span class=p>)();</span>
</span></span></code></pre></td></tr></table></div></div><h3 id=wasm-bundlejs>wasm-bundle.js<a hidden class=anchor aria-hidden=true href=#wasm-bundlejs>#</a></h3><blockquote><p>???</p></blockquote><p>남은 wasm.js를 봐야겠습니다.</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-javascript data-lang=javascript><span class=line><span class=cl><span class=nx>module</span><span class=p>.</span><span class=nx>exports</span> <span class=o>=</span> <span class=nx>require</span><span class=p>(</span><span class=s1>&#39;./libheif-wasm/libheif-bundle.js&#39;</span><span class=p>)();</span>
</span></span></code></pre></td></tr></table></div></div><h3 id=wasmjs>wasm.js<a hidden class=anchor aria-hidden=true href=#wasmjs>#</a></h3><p>자, 여기까지 나온 것을 보고 생각해 보았습니다.
이제 찾아야 하는 것은 다음 폴더들이 어떻게 만들어지는지 알아보는 것입니다.</p><ol><li>libheif-wasm</li></ol><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span><span class=lnt>5
</span><span class=lnt>6
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-javascript data-lang=javascript><span class=line><span class=cl><span class=c1>// I technically don&#39;t have to do this, but I am keeping it around
</span></span></span><span class=line><span class=cl><span class=c1>// for demonstration purposes
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=kr>const</span> <span class=nx>fs</span> <span class=o>=</span> <span class=nx>require</span><span class=p>(</span><span class=s1>&#39;fs&#39;</span><span class=p>);</span>
</span></span><span class=line><span class=cl><span class=kr>const</span> <span class=nx>wasmBinary</span> <span class=o>=</span> <span class=nx>fs</span><span class=p>.</span><span class=nx>readFileSync</span><span class=p>(</span><span class=s1>&#39;./libheif-wasm/libheif.wasm&#39;</span><span class=p>);</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=nx>module</span><span class=p>.</span><span class=nx>exports</span> <span class=o>=</span> <span class=nx>require</span><span class=p>(</span><span class=s1>&#39;./libheif-wasm/libheif.js&#39;</span><span class=p>)({</span> <span class=nx>wasmBinary</span> <span class=p>});</span>
</span></span></code></pre></td></tr></table></div></div><h3 id=scriptsinstalljs>scripts/install.js<a hidden class=anchor aria-hidden=true href=#scriptsinstalljs>#</a></h3><p>일단 libheif를 설치하는 부분으로 보입니다. libheif를 다운받고, esbuild를 통해 <code>libheif-wasm/libheif-bundle.js</code>를 만들어 내는 군요</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span><span class=lnt>21
</span><span class=lnt>22
</span><span class=lnt>23
</span><span class=lnt>24
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-javascript data-lang=javascript><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1>// ...
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=kr>const</span> <span class=nx>base</span> <span class=o>=</span> <span class=sb>`https://github.com/catdad-experiments/libheif-emscripten/releases/download/</span><span class=si>${</span><span class=nx>version</span><span class=si>}</span><span class=sb>`</span><span class=p>;</span>
</span></span><span class=line><span class=cl><span class=kr>const</span> <span class=nx>tarball</span> <span class=o>=</span> <span class=sb>`</span><span class=si>${</span><span class=nx>base</span><span class=si>}</span><span class=sb>/libheif.tar.gz`</span><span class=p>;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1>// ...
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=p>(</span><span class=kr>async</span> <span class=p>()</span> <span class=p>=&gt;</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>      <span class=c1>// ...
</span></span></span><span class=line><span class=cl><span class=c1></span>
</span></span><span class=line><span class=cl>          <span class=kr>await</span> <span class=nx>fs</span><span class=p>.</span><span class=nx>outputFile</span><span class=p>(</span><span class=nx>outfile</span><span class=p>,</span> <span class=kr>await</span> <span class=nx>autoReadStream</span><span class=p>(</span><span class=nx>entry</span><span class=p>));</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>      <span class=c1>//...
</span></span></span><span class=line><span class=cl><span class=c1></span>
</span></span><span class=line><span class=cl>      <span class=kr>await</span> <span class=nx>esbuild</span><span class=p>.</span><span class=nx>build</span><span class=p>({</span>
</span></span><span class=line><span class=cl>        <span class=p>...</span><span class=nx>buildOptions</span><span class=p>,</span>
</span></span><span class=line><span class=cl>        <span class=nx>outfile</span><span class=o>:</span> <span class=nx>path</span><span class=p>.</span><span class=nx>resolve</span><span class=p>(</span><span class=nx>root</span><span class=p>,</span> <span class=s1>&#39;libheif-wasm/libheif-bundle.js&#39;</span><span class=p>),</span>
</span></span><span class=line><span class=cl>        <span class=nx>format</span><span class=o>:</span> <span class=s1>&#39;iife&#39;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>        <span class=nx>globalName</span><span class=o>:</span> <span class=s1>&#39;libheif&#39;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>        <span class=c1>//...
</span></span></span><span class=line><span class=cl><span class=c1></span>      <span class=p>});</span>
</span></span><span class=line><span class=cl><span class=c1>// ...
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=p>})</span>
</span></span><span class=line><span class=cl><span class=c1>//...
</span></span></span></code></pre></td></tr></table></div></div><h3 id=정리-2>정리<a hidden class=anchor aria-hidden=true href=#정리-2>#</a></h3><p>libheif를 직접 다운 받아 libheif를 번들링 합니다. libheif/libheif.js는 <code>libheif-emscripten</code>을 살펴 봐야겠습니다.</p><h2 id=libheif-emscripten>libheif-emscripten<a hidden class=anchor aria-hidden=true href=#libheif-emscripten>#</a></h2><p>파일이 별게 없군요. githu workflow와 스크립트 파일 정도를 살펴볼 수 있겠습니다.</p><h3 id=dist-prepsh>dist-prep.sh<a hidden class=anchor aria-hidden=true href=#dist-prepsh>#</a></h3><p>dist로 <code>libheif.js</code>를 복사하는 스크립트입니다. 이 스크립트가 시작될때면 <code>libheif.js</code>를 가지고 있다는 말이 된다는 이야기네요.</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span><span class=lnt>21
</span><span class=lnt>22
</span><span class=lnt>23
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-sh data-lang=sh><span class=line><span class=cl>// ...
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=nv>build_target</span><span class=o>=</span><span class=s2>&#34;</span><span class=nv>$1</span><span class=s2>&#34;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>// ...
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=k>function</span> copyJs<span class=o>()</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>  cp libheif/libheif.js dist/libheif.js
</span></span><span class=line><span class=cl>  cp libheif/COPYING dist/LICENSE
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>  assertFile dist/libheif.js
</span></span><span class=line><span class=cl>  assertFile dist/LICENSE
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>  chown <span class=k>$(</span>whoami<span class=k>)</span> dist/libheif.js dist/LICENSE
</span></span><span class=line><span class=cl><span class=o>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>// ...
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=k>if</span> <span class=o>[</span> <span class=s2>&#34;</span><span class=nv>$build_target</span><span class=s2>&#34;</span> <span class=o>=</span> <span class=s2>&#34;js&#34;</span> <span class=o>]</span>
</span></span><span class=line><span class=cl><span class=k>then</span>
</span></span><span class=line><span class=cl>  copyJs
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>// ...
</span></span></code></pre></td></tr></table></div></div><h3 id=githubworkflowsemscriptenyml>.github/workflows/emscripten.yml<a hidden class=anchor aria-hidden=true href=#githubworkflowsemscriptenyml>#</a></h3><p>아, 드디어 찾았습니다. libheif를 여기서 다운을 받는 군요. 이제 libheif를 살펴보면 될 것 같습니다.
libheif의 스크립트 중 <code>install-cli-linux.sh</code>, <code>prepare-ci.sh</code>, <code>run-ci.sh</code>를 보면 되겠군요.</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-yml data-lang=yml><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=l>// ...</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span>- <span class=nt>name</span><span class=p>:</span><span class=w> </span><span class=l>Install emscripten</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=nt>working-directory</span><span class=p>:</span><span class=w> </span><span class=l>libheif</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=nt>run</span><span class=p>:</span><span class=w> </span><span class=p>|</span><span class=sd>
</span></span></span><span class=line><span class=cl><span class=sd>        </span><span class=w>        </span><span class=l>./scripts/install-ci-linux.sh</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span>- <span class=nt>name</span><span class=p>:</span><span class=w> </span><span class=l>Prepare CI</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=nt>working-directory</span><span class=p>:</span><span class=w> </span><span class=l>libheif</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=nt>run</span><span class=p>:</span><span class=w> </span><span class=p>|</span><span class=sd>
</span></span></span><span class=line><span class=cl><span class=sd>        </span><span class=w>        </span><span class=l>./scripts/prepare-ci.sh</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span>- <span class=nt>name</span><span class=p>:</span><span class=w> </span><span class=l>Run build and tests (JS)</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=nt>if</span><span class=p>:</span><span class=w> </span><span class=l>${{ matrix.target==&#39;js&#39; }}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=nt>working-directory</span><span class=p>:</span><span class=w> </span><span class=l>libheif</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=nt>run</span><span class=p>:</span><span class=w> </span><span class=p>|</span><span class=sd>
</span></span></span><span class=line><span class=cl><span class=sd>        </span><span class=w>        </span><span class=l>./scripts/run-ci.sh</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=l>// ...</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>   </span>- <span class=nt>name</span><span class=p>:</span><span class=w> </span><span class=l>Dist prep</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=nt>run</span><span class=p>:</span><span class=w> </span><span class=l>./dist-prep.sh ${{ matrix.target }}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=l>// ...</span><span class=w>
</span></span></span></code></pre></td></tr></table></div></div><h3 id=정리-3>정리<a hidden class=anchor aria-hidden=true href=#정리-3>#</a></h3><p>libheif의 스크립트를 이용해 libheif.js를 만들어 냅니다.</p><h2 id=libheif>libheif<a hidden class=anchor aria-hidden=true href=#libheif>#</a></h2><p>sh파일은 길기 때문에 제가 읽고 파악한 부분만 서술하겠습니다.</p><h3 id=install-ci-linuxsh>install-ci-linux.sh<a hidden class=anchor aria-hidden=true href=#install-ci-linuxsh>#</a></h3><p>decoder(libde265), encoder(x265) 등을 다운 받습니다.</p><h3 id=prepare-cish>prepare-ci.sh<a hidden class=anchor aria-hidden=true href=#prepare-cish>#</a></h3><p>flag를 기준으로 포함하는 PKG_CONFIG_PATH를 설정합니다.</p><h3 id=run-cish>run-ci.sh<a hidden class=anchor aria-hidden=true href=#run-cish>#</a></h3><p>여기서 <code>build-emscripten.sh</code>를 호출해 파일을 생성하는 것으로 보입니다.
<a href=https://emscripten.org/>emscripten</a>은 LLVM컴파일러의 백엔드로, 소스를 javascript/wasm로 변환할 수 있는 프로그램이라고 합니다.</p><h3 id=build-emscriptensh>build-emscripten.sh<a hidden class=anchor aria-hidden=true href=#build-emscriptensh>#</a></h3><p>여기서 post.js를 기반으로 한 파일을 만들어 줍니다. 실제로 post.js를 보면 어떻게 사용하고 있는지 볼 수 있습니다.</p><h3 id=정리-4>정리<a hidden class=anchor aria-hidden=true href=#정리-4>#</a></h3><p>차례로 dependency를 설치 및 설정하고 <code>build-emscripten.sh</code>에서 emscripten을 이용해 libheif.js를 생성합니다.</p><h1 id=정리하기>정리하기<a hidden class=anchor aria-hidden=true href=#정리하기>#</a></h1><h2 id=긴-여정이었습니다>긴 여정이었습니다.<a hidden class=anchor aria-hidden=true href=#긴-여정이었습니다>#</a></h2><p>지금까지 5개의 레포를 넘어가면서 어떻게 libheif.js 파일이 생성되는지를 알아보았습니다.
결과적으로 <code>heic-convert</code>라이브러리는 libheif.js를 기반으로 돌고 있으며, 이를 이용해 HEIF파일을 다른 형식으로 전환할 수 있다는 것을 알았습니다.
별안간 지식이 늘어 기쁘네요.</p><p>그럼 긴 글 읽어 주셔서 감사드리며, 이만 물러가겠습니다.</p><h1 id=ref>ref<a hidden class=anchor aria-hidden=true href=#ref>#</a></h1><ul><li><a href=https://cloudinary.com/guides/image-formats/heif-format-meet-the-the-next-evolution-of-jpeg>https://cloudinary.com/guides/image-formats/heif-format-meet-the-the-next-evolution-of-jpeg</a></li><li><a href=https://namu.wiki/w/HEIF>킹무위키 HEIF</a></li><li><a href=https://github.com/catdad-experiments/heic-convert>heic-convert</a></li><li><a href=https://github.com/catdad-experiments/heic-decode>heic-decode</a></li><li><a href=https://github.com/catdad-experiments/libheif-js>libheif-js</a></li><li><a href=https://github.com/catdad-experiments/libheif-emscripten>libheif-emscripten</a></li><li><a href=https://github.com/strukturag/libheif>libheif</a></li><li><a href=https://ko.wikipedia.org/wiki/Emscripten>emscripten</a></li></ul></div><footer class=post-footer><ul class=post-tags><li><a href=https://heozeop.github.io/tags/%EC%9D%B4%EB%AF%B8%EC%A7%80%EC%B2%98%EB%A6%AC/>이미지처리</a></li><li><a href=https://heozeop.github.io/tags/node/>Node</a></li></ul><nav class=paginav><a class=prev href=https://heozeop.github.io/post/first-week-of-next-step/><span class=title>« Prev</span><br><span>[회고] next step ATDD with Spring 1주차</span></a>
<a class=next href=https://heozeop.github.io/post/book-report-god-of-java/><span class=title>Next »</span><br><span>자바의 신 독후감 & 정리</span></a></nav><div class=share-buttons><a target=_blank rel="noopener noreferrer" aria-label="share [회고] heic-convert 분석 - NodeJS 라이브러리 on twitter" href="https://twitter.com/intent/tweet/?text=%5b%ed%9a%8c%ea%b3%a0%5d%20heic-convert%20%eb%b6%84%ec%84%9d%20-%20NodeJS%20%eb%9d%bc%ec%9d%b4%eb%b8%8c%eb%9f%ac%eb%a6%ac&url=https%3a%2f%2fheozeop.github.io%2fpost%2fresearch-heic-converter%2f&hashtags=%ec%9d%b4%eb%af%b8%ec%a7%80%ec%b2%98%eb%a6%ac%2cNode"><svg viewBox="0 0 512 512"><path d="M449.446.0C483.971.0 512 28.03 512 62.554v386.892C512 483.97 483.97 512 449.446 512H62.554c-34.524.0-62.554-28.03-62.554-62.554V62.554c0-34.524 28.029-62.554 62.554-62.554h386.892zM195.519 424.544c135.939.0 210.268-112.643 210.268-210.268.0-3.218.0-6.437-.153-9.502 14.406-10.421 26.973-23.448 36.935-38.314-13.18 5.824-27.433 9.809-42.452 11.648 15.326-9.196 26.973-23.602 32.49-40.92-14.252 8.429-30.038 14.56-46.896 17.931-13.487-14.406-32.644-23.295-53.946-23.295-40.767.0-73.87 33.104-73.87 73.87.0 5.824.613 11.494 1.992 16.858-61.456-3.065-115.862-32.49-152.337-77.241-6.284 10.881-9.962 23.601-9.962 37.088.0 25.594 13.027 48.276 32.95 61.456-12.107-.307-23.448-3.678-33.41-9.196v.92c0 35.862 25.441 65.594 59.311 72.49-6.13 1.686-12.72 2.606-19.464 2.606-4.751.0-9.348-.46-13.946-1.38 9.349 29.426 36.628 50.728 68.965 51.341-25.287 19.771-57.164 31.571-91.8 31.571-5.977.0-11.801-.306-17.625-1.073 32.337 21.15 71.264 33.41 112.95 33.41z"/></svg></a><a target=_blank rel="noopener noreferrer" aria-label="share [회고] heic-convert 분석 - NodeJS 라이브러리 on linkedin" href="https://www.linkedin.com/shareArticle?mini=true&url=https%3a%2f%2fheozeop.github.io%2fpost%2fresearch-heic-converter%2f&title=%5b%ed%9a%8c%ea%b3%a0%5d%20heic-convert%20%eb%b6%84%ec%84%9d%20-%20NodeJS%20%eb%9d%bc%ec%9d%b4%eb%b8%8c%eb%9f%ac%eb%a6%ac&summary=%5b%ed%9a%8c%ea%b3%a0%5d%20heic-convert%20%eb%b6%84%ec%84%9d%20-%20NodeJS%20%eb%9d%bc%ec%9d%b4%eb%b8%8c%eb%9f%ac%eb%a6%ac&source=https%3a%2f%2fheozeop.github.io%2fpost%2fresearch-heic-converter%2f"><svg viewBox="0 0 512 512"><path d="M449.446.0C483.971.0 512 28.03 512 62.554v386.892C512 483.97 483.97 512 449.446 512H62.554c-34.524.0-62.554-28.03-62.554-62.554V62.554c0-34.524 28.029-62.554 62.554-62.554h386.892zM160.461 423.278V197.561h-75.04v225.717h75.04zm270.539.0V293.839c0-69.333-37.018-101.586-86.381-101.586-39.804.0-57.634 21.891-67.617 37.266v-31.958h-75.021c.995 21.181.0 225.717.0 225.717h75.02V297.222c0-6.748.486-13.492 2.474-18.315 5.414-13.475 17.767-27.434 38.494-27.434 27.135.0 38.007 20.707 38.007 51.037v120.768H431zM123.448 88.722C97.774 88.722 81 105.601 81 127.724c0 21.658 16.264 39.002 41.455 39.002h.484c26.165.0 42.452-17.344 42.452-39.002-.485-22.092-16.241-38.954-41.943-39.002z"/></svg></a><a target=_blank rel="noopener noreferrer" aria-label="share [회고] heic-convert 분석 - NodeJS 라이브러리 on reddit" href="https://reddit.com/submit?url=https%3a%2f%2fheozeop.github.io%2fpost%2fresearch-heic-converter%2f&title=%5b%ed%9a%8c%ea%b3%a0%5d%20heic-convert%20%eb%b6%84%ec%84%9d%20-%20NodeJS%20%eb%9d%bc%ec%9d%b4%eb%b8%8c%eb%9f%ac%eb%a6%ac"><svg viewBox="0 0 512 512"><path d="M449.446.0C483.971.0 512 28.03 512 62.554v386.892C512 483.97 483.97 512 449.446 512H62.554c-34.524.0-62.554-28.03-62.554-62.554V62.554c0-34.524 28.029-62.554 62.554-62.554h386.892zM446 265.638c0-22.964-18.616-41.58-41.58-41.58-11.211.0-21.361 4.457-28.841 11.666-28.424-20.508-67.586-33.757-111.204-35.278l18.941-89.121 61.884 13.157c.756 15.734 13.642 28.29 29.56 28.29 16.407.0 29.706-13.299 29.706-29.701.0-16.403-13.299-29.702-29.706-29.702-11.666.0-21.657 6.792-26.515 16.578l-69.105-14.69c-1.922-.418-3.939-.042-5.585 1.036-1.658 1.073-2.811 2.761-3.224 4.686l-21.152 99.438c-44.258 1.228-84.046 14.494-112.837 35.232-7.468-7.164-17.589-11.591-28.757-11.591-22.965.0-41.585 18.616-41.585 41.58.0 16.896 10.095 31.41 24.568 37.918-.639 4.135-.99 8.328-.99 12.576.0 63.977 74.469 115.836 166.33 115.836s166.334-51.859 166.334-115.836c0-4.218-.347-8.387-.977-12.493 14.564-6.47 24.735-21.034 24.735-38.001zM326.526 373.831c-20.27 20.241-59.115 21.816-70.534 21.816-11.428.0-50.277-1.575-70.522-21.82-3.007-3.008-3.007-7.882.0-10.889 3.003-2.999 7.882-3.003 10.885.0 12.777 12.781 40.11 17.317 59.637 17.317 19.522.0 46.86-4.536 59.657-17.321 3.016-2.999 7.886-2.995 10.885.008 3.008 3.011 3.003 7.882-.008 10.889zm-5.23-48.781c-16.373.0-29.701-13.324-29.701-29.698.0-16.381 13.328-29.714 29.701-29.714 16.378.0 29.706 13.333 29.706 29.714.0 16.374-13.328 29.698-29.706 29.698zM160.91 295.348c0-16.381 13.328-29.71 29.714-29.71 16.369.0 29.689 13.329 29.689 29.71.0 16.373-13.32 29.693-29.689 29.693-16.386.0-29.714-13.32-29.714-29.693z"/></svg></a><a target=_blank rel="noopener noreferrer" aria-label="share [회고] heic-convert 분석 - NodeJS 라이브러리 on facebook" href="https://facebook.com/sharer/sharer.php?u=https%3a%2f%2fheozeop.github.io%2fpost%2fresearch-heic-converter%2f"><svg viewBox="0 0 512 512"><path d="M449.446.0C483.971.0 512 28.03 512 62.554v386.892C512 483.97 483.97 512 449.446 512H342.978V319.085h66.6l12.672-82.621h-79.272v-53.617c0-22.603 11.073-44.636 46.58-44.636H425.6v-70.34s-32.71-5.582-63.982-5.582c-65.288.0-107.96 39.569-107.96 111.204v62.971h-72.573v82.621h72.573V512h-191.104c-34.524.0-62.554-28.03-62.554-62.554V62.554c0-34.524 28.029-62.554 62.554-62.554h386.892z"/></svg></a><a target=_blank rel="noopener noreferrer" aria-label="share [회고] heic-convert 분석 - NodeJS 라이브러리 on whatsapp" href="https://api.whatsapp.com/send?text=%5b%ed%9a%8c%ea%b3%a0%5d%20heic-convert%20%eb%b6%84%ec%84%9d%20-%20NodeJS%20%eb%9d%bc%ec%9d%b4%eb%b8%8c%eb%9f%ac%eb%a6%ac%20-%20https%3a%2f%2fheozeop.github.io%2fpost%2fresearch-heic-converter%2f"><svg viewBox="0 0 512 512"><path d="M449.446.0C483.971.0 512 28.03 512 62.554v386.892C512 483.97 483.97 512 449.446 512H62.554c-34.524.0-62.554-28.03-62.554-62.554V62.554c0-34.524 28.029-62.554 62.554-62.554h386.892zm-58.673 127.703c-33.842-33.881-78.847-52.548-126.798-52.568-98.799.0-179.21 80.405-179.249 179.234-.013 31.593 8.241 62.428 23.927 89.612l-25.429 92.884 95.021-24.925c26.181 14.28 55.659 21.807 85.658 21.816h.074c98.789.0 179.206-80.413 179.247-179.243.018-47.895-18.61-92.93-52.451-126.81zM263.976 403.485h-.06c-26.734-.01-52.954-7.193-75.828-20.767l-5.441-3.229-56.386 14.792 15.05-54.977-3.542-5.637c-14.913-23.72-22.791-51.136-22.779-79.287.033-82.142 66.867-148.971 149.046-148.971 39.793.014 77.199 15.531 105.329 43.692 28.128 28.16 43.609 65.592 43.594 105.4-.034 82.149-66.866 148.983-148.983 148.984zm81.721-111.581c-4.479-2.242-26.499-13.075-30.604-14.571-4.105-1.495-7.091-2.241-10.077 2.241-2.986 4.483-11.569 14.572-14.182 17.562-2.612 2.988-5.225 3.364-9.703 1.12-4.479-2.241-18.91-6.97-36.017-22.23C231.8 264.15 222.81 249.484 220.198 245s-.279-6.908 1.963-9.14c2.016-2.007 4.48-5.232 6.719-7.847 2.24-2.615 2.986-4.484 4.479-7.472 1.493-2.99.747-5.604-.374-7.846-1.119-2.241-10.077-24.288-13.809-33.256-3.635-8.733-7.327-7.55-10.077-7.688-2.609-.13-5.598-.158-8.583-.158-2.986.0-7.839 1.121-11.944 5.604-4.105 4.484-15.675 15.32-15.675 37.364.0 22.046 16.048 43.342 18.287 46.332 2.24 2.99 31.582 48.227 76.511 67.627 10.685 4.615 19.028 7.371 25.533 9.434 10.728 3.41 20.492 2.929 28.209 1.775 8.605-1.285 26.499-10.833 30.231-21.295 3.732-10.464 3.732-19.431 2.612-21.298-1.119-1.869-4.105-2.99-8.583-5.232z"/></svg></a><a target=_blank rel="noopener noreferrer" aria-label="share [회고] heic-convert 분석 - NodeJS 라이브러리 on telegram" href="https://telegram.me/share/url?text=%5b%ed%9a%8c%ea%b3%a0%5d%20heic-convert%20%eb%b6%84%ec%84%9d%20-%20NodeJS%20%eb%9d%bc%ec%9d%b4%eb%b8%8c%eb%9f%ac%eb%a6%ac&url=https%3a%2f%2fheozeop.github.io%2fpost%2fresearch-heic-converter%2f"><svg viewBox="2 2 28 28"><path d="M26.49 29.86H5.5a3.37 3.37.0 01-2.47-1 3.35 3.35.0 01-1-2.47V5.48A3.36 3.36.0 013 3 3.37 3.37.0 015.5 2h21A3.38 3.38.0 0129 3a3.36 3.36.0 011 2.46V26.37a3.35 3.35.0 01-1 2.47 3.38 3.38.0 01-2.51 1.02zm-5.38-6.71a.79.79.0 00.85-.66L24.73 9.24a.55.55.0 00-.18-.46.62.62.0 00-.41-.17q-.08.0-16.53 6.11a.59.59.0 00-.41.59.57.57.0 00.43.52l4 1.24 1.61 4.83a.62.62.0 00.63.43.56.56.0 00.4-.17L16.54 20l4.09 3A.9.9.0 0021.11 23.15zM13.8 20.71l-1.21-4q8.72-5.55 8.78-5.55c.15.0.23.0.23.16a.18.18.0 010 .06s-2.51 2.3-7.52 6.8z"/></svg></a></div></footer><script src=https://utteranc.es/client.js repo=heozeop/heozeop.github.io issue-term=title label=Comment theme=preferred-color-scheme crossorigin=anonymous async></script></article></main><footer class=footer><span>&copy; 2024 <a href=https://heozeop.github.io/>Crispy bLog</a></span>
<span>Powered by
<a href=https://gohugo.io/ rel="noopener noreferrer" target=_blank>Hugo</a> &
        <a href=https://github.com/adityatelange/hugo-PaperMod/ rel=noopener target=_blank>PaperMod</a></span></footer><script>let menu=document.getElementById("menu");menu&&(menu.scrollLeft=localStorage.getItem("menu-scroll-position"),menu.onscroll=function(){localStorage.setItem("menu-scroll-position",menu.scrollLeft)}),document.querySelectorAll('a[href^="#"]').forEach(e=>{e.addEventListener("click",function(e){e.preventDefault();var t=this.getAttribute("href").substr(1);window.matchMedia("(prefers-reduced-motion: reduce)").matches?document.querySelector(`[id='${decodeURIComponent(t)}']`).scrollIntoView():document.querySelector(`[id='${decodeURIComponent(t)}']`).scrollIntoView({behavior:"smooth"}),t==="top"?history.replaceState(null,null," "):history.pushState(null,null,`#${t}`)})})</script><script>document.getElementById("theme-toggle").addEventListener("click",()=>{document.body.className.includes("dark")?(document.body.classList.remove("dark"),localStorage.setItem("pref-theme","light")):(document.body.classList.add("dark"),localStorage.setItem("pref-theme","dark"))})</script><script>document.querySelectorAll("pre > code").forEach(e=>{const n=e.parentNode.parentNode,t=document.createElement("button");t.classList.add("copy-code"),t.innerHTML="copy";function s(){t.innerHTML="copied!",setTimeout(()=>{t.innerHTML="copy"},2e3)}t.addEventListener("click",t=>{if("clipboard"in navigator){navigator.clipboard.writeText(e.textContent),s();return}const n=document.createRange();n.selectNodeContents(e);const o=window.getSelection();o.removeAllRanges(),o.addRange(n);try{document.execCommand("copy"),s()}catch{}o.removeRange(n)}),n.classList.contains("highlight")?n.appendChild(t):n.parentNode.firstChild==n||(e.parentNode.parentNode.parentNode.parentNode.parentNode.nodeName=="TABLE"?e.parentNode.parentNode.parentNode.parentNode.parentNode.appendChild(t):e.parentNode.appendChild(t))})</script></body></html>